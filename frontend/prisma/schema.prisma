generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm]
}

enum UserRole {
  USER
  ADMIN
}

enum AuthorType {
  ANONYMOUS
  USER
}

enum AuthorBadge {
  NONE
  VERIFIED_ACCOUNT
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
  REMOVED
}

enum ModerationAction {
  APPROVE
  REJECT
  REQUEST_CHANGES
  REMOVE
}

enum ReviewEditorType {
  AUTHOR
  ADMIN
}

enum ReporterType {
  ANONYMOUS
  USER
}

enum ReportReason {
  PII
  Harassment
  FalseInfo
  Spam
  Other
}

enum RateLimitEventType {
  REVIEW_SUBMISSION
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  role             UserRole  @default(USER)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  displayName      String?
  localePreference String?
  sessions         Session[]
  reviews          Review[]
  reports          Report[]  @relation("ReporterUser")
  moderationLogs   ModerationAudit[]

  @@index([role])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model MagicLinkToken {
  id        String   @id @default(uuid())
  email     String
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  usedAt    DateTime?
  ip        String?
  userAgent String?

  @@index([email])
  @@index([expiresAt])
}

model Country {
  id        String   @id @default(uuid())
  code      String   @unique
  nameEn    String
  namePt    String
  createdAt DateTime @default(now())
  cities    City[]
}

model City {
  id             String   @id @default(uuid())
  countryId      String
  name           String
  normalizedName String
  createdAt      DateTime @default(now())
  country        Country  @relation(fields: [countryId], references: [id], onDelete: Restrict)
  areas          Area[]

  @@index([countryId, normalizedName])
}

model Area {
  id             String   @id @default(uuid())
  cityId         String
  name           String
  normalizedName String
  createdAt      DateTime @default(now())
  city           City     @relation(fields: [cityId], references: [id], onDelete: Restrict)
  streets        Street[]

  @@index([cityId, normalizedName])
}

model Street {
  id             String   @id @default(uuid())
  areaId         String
  name           String
  normalizedName String
  createdAt      DateTime @default(now())
  area           Area     @relation(fields: [areaId], references: [id], onDelete: Restrict)
  segments       StreetSegment[]
  buildings      Building[]

  @@index([areaId, normalizedName])
}

model StreetSegment {
  id          String   @id @default(uuid())
  streetId    String
  startNumber Int
  endNumber   Int
  createdAt   DateTime @default(now())
  street      Street   @relation(fields: [streetId], references: [id], onDelete: Restrict)
  buildings   Building[]

  @@index([streetId, startNumber, endNumber])
}

model Building {
  id           String   @id @default(uuid())
  streetId      String
  segmentId     String
  streetNumber  Int
  buildingName  String?
  lat           Decimal? @db.Decimal(10, 7)
  lng           Decimal? @db.Decimal(10, 7)
  createdAt     DateTime @default(now())
  street        Street   @relation(fields: [streetId], references: [id], onDelete: Restrict)
  segment       StreetSegment @relation(fields: [segmentId], references: [id], onDelete: Restrict)
  reviews       Review[]

  @@unique([streetId, streetNumber])
  @@index([lat, lng])
}

model Review {
  id                    String      @id @default(uuid())
  buildingId             String
  authorUserId           String?
  authorType             AuthorType
  authorBadge            AuthorBadge @default(NONE)
  status                 ReviewStatus @default(PENDING)
  trackingCode           String      @unique
  editTokenHash          String?
  editTokenExpiresAt     DateTime?
  languageTag            String?
  livedFromYear          Int
  livedToYear            Int?
  livedDurationMonths    Int
  peopleNoise            Int
  animalNoise            Int
  insulation             Int
  pestIssues             Int
  areaSafety             Int
  neighbourhoodVibe      Int
  outdoorSpaces          Int
  parking                Int
  buildingMaintenance    Int
  constructionQuality    Int
  overallScore           Decimal     @db.Decimal(3, 2)
  overallScoreRounded    Decimal     @db.Decimal(2, 1)
  comment                String?
  piiFlagged             Boolean     @default(false)
  piiReasons             String[]
  submitIp               String?
  submitFingerprint      String?
  contactEmail           String?
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt
  approvedAt             DateTime?
  removedAt              DateTime?
  lastModerationAction   ModerationAction?
  moderationMessage      String?
  moderatedByUserId      String?
  building               Building    @relation(fields: [buildingId], references: [id], onDelete: Restrict)
  authorUser             User?       @relation(fields: [authorUserId], references: [id], onDelete: SetNull)
  edits                  ReviewEditHistory[]
  reports                Report[]

  @@index([buildingId, status])
  @@index([status, createdAt])
  @@index([overallScore])
  @@index([submitIp, createdAt])
  @@index([submitFingerprint, createdAt])
}

model ReviewEditHistory {
  id         String           @id @default(uuid())
  reviewId    String
  editorType  ReviewEditorType
  beforeJson  Json
  afterJson   Json
  createdAt   DateTime @default(now())
  review      Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId, createdAt])
}

model Report {
  id                String      @id @default(uuid())
  reviewId           String
  reporterType       ReporterType
  reporterUserId     String?
  reason             ReportReason
  details            String?
  createdAt          DateTime @default(now())
  resolvedAt         DateTime?
  resolvedByUserId   String?
  resolutionNote     String?
  review             Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reporterUser       User?    @relation("ReporterUser", fields: [reporterUserId], references: [id], onDelete: SetNull)

  @@index([reviewId])
  @@index([createdAt])
  @@index([resolvedAt])
}

model RateLimitEvent {
  id          String             @id @default(uuid())
  ip          String?
  fingerprint String?
  buildingId  String?
  type        RateLimitEventType
  createdAt   DateTime @default(now())

  @@index([type, createdAt])
  @@index([ip, createdAt])
  @@index([fingerprint, createdAt])
  @@index([buildingId, createdAt])
}

model ModerationAudit {
  id            String   @id @default(uuid())
  reviewId       String
  actorUserId    String
  action         ModerationAction
  message        String?
  beforeJson     Json?
  afterJson      Json?
  createdAt      DateTime @default(now())
  actorUser      User     @relation(fields: [actorUserId], references: [id], onDelete: Restrict)

  @@index([reviewId, createdAt])
}
